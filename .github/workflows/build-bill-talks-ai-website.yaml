name: Build Bill Talks AI website

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # you can trigger the workflow manually

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true # this workflow stops other concurrent workflows from running

jobs:
  build-bill-talks-ai-website:
    runs-on: ubuntu-latest
    env:
      WORKSPACE_PATH: /workspaces/ # when the action opens the dockerfile, use this as the top-level folder
      REPO_NAME: ${{ github.event.repository.name }} # when the action opens the dockerfile, use this as the top-level sub-folder
      BILL_TALKS_AI_PAT: ${{ secrets.BILL_TALKS_AI_PAT }} # Secret code created from developer settings

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true # Fetch Git submodules that Hugo might use

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5 # In this case, used for building the Dockerfile, not for pushing
      with:
        context: .
        file: ./Dockerfile # Open the dockerfile in this GitHub repo
        load: true
        tags: my-custom-image:latest # temporary image name and tag

    - name: Run Docker container, build with Hugo, and list public contents
      run: |
        docker run --name temp-container -v ${{ github.workspace }}:${{ env.WORKSPACE_PATH }}${{ env.REPO_NAME }} my-custom-image:latest /bin/bash -c "\
          cd ${{ env.WORKSPACE_PATH }}${{ env.REPO_NAME }} && 
          set -x; \
          echo 'Here is a list of the files in ${{ env.WORKSPACE_PATH }}${{ env.REPO_NAME }}' && \
          ls -la && \
          echo 'Install Bootstrap just in case files are missing' && \
          npm install bootstrap && \
          echo 'Use package.json file to copy bootstrap files to the static folder' && \
          npm run copy-bootstrap && \
          echo 'Build the Hugo site' && \
          hugo -s . -d public --gc --cleanDestinationDir --minify --logLevel debug"

    - name: Checkout target repository in a separate directory
      uses: actions/checkout@v4
      with:
        repository: 'BillRaymond/bill-talks-ai-website'
        token: ${{ secrets.BILL_TALKS_AI_PAT }}
        path: 'target_repo'
        ref: main

    - name: Sync site content to target repository
      run: |
        echo 'rsync'
        rsync -av --delete public/ target_repo/

    - name: Custom Push to Target Repository
      run: |
        cd target_repo
        echo 'Here is a list of the files in /target repo'
        ls -la
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git status
        git commit -m "Update site content via GitHub Actions" || echo "No changes to commit"
        git push origin main
      env:
        GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"